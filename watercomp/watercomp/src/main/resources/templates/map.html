<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Su Hackathon - SensÃ¶r Takip</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; } /* Harita tÃ¼m ekranÄ± kaplasÄ±n */
        
        /* SaÄŸ Ã¼st kÃ¶ÅŸeye ÅŸÄ±k bir bilgi kutusu ekleyelim */
        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-family: sans-serif;
        }
    </style>
</head>
<body>

    <div class="info-box">
        <h3>ğŸŒ± Tarla Durumu</h3>
        <p>SensÃ¶r verileri canlÄ± Ã§ekiliyor...</p>
        <button onclick="loadSensors()">Verileri Yenile</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. HaritayÄ± BaÅŸlat (Merkez: Konya KapsÃ¼l Platformu, Zoom: 13)
        var map = L.map('map').setView([37.8715, 32.4921], 13);

        // 2. Harita KatmanÄ±nÄ± Ekle (OpenStreetMap - Ãœcretsiz)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 3. Backend'den Veri Ã‡eken Fonksiyon
        function loadSensors() {
            console.log("Veriler Ã§ekiliyor...");
            
            fetch('http://localhost:8080/api/sensors/all')
                .then(response => response.json())
                .then(data => {
                    console.log("Gelen Veri:", data);
                    
                    // Ã–nceki markerlarÄ± temizlemek gerekebilir ama ÅŸimdilik Ã¼stÃ¼ne ekleyelim
                    
                    data.forEach(sensor => {
                        // DÄ°KKAT: GeoJSON [Boylam, Enlem] verir.
                        // Leaflet [Enlem, Boylam] ister. TERS Ã‡EVÄ°RÄ°YORUZ!
                        var lat = sensor.location.coordinates[1]; 
                        var lon = sensor.location.coordinates[0];
                        
                        // Renk belirleme mantÄ±ÄŸÄ± (Basit bir gÃ¶rselleÅŸtirme)
                        var status = sensor.soilMoisture < 30 ? "ğŸ”´ Kritik (Kuru)" : "ğŸŸ¢ Ä°yi";

                        // Marker oluÅŸtur ve haritaya ekle
                        L.marker([lat, lon])
                            .addTo(map)
                            .bindPopup(`
                                <b>SensÃ¶r ID:</b> ${sensor.id}<br>
                                <b>Nem:</b> %${sensor.soilMoisture}<br>
                                <b>Durum:</b> ${status}<br>
                                <small>${sensor.timestamp}</small>
                            `);
                    });
                })
                .catch(error => console.error('Hata:', error));
        }

        // Sayfa aÃ§Ä±lÄ±nca verileri yÃ¼kle
        loadSensors();

        // Haritaya tÄ±klayÄ±nca koordinatlarÄ± konsola yaz (Test iÃ§in faydalÄ±)
        map.on('click', function(e) {
            console.log("TÄ±klanan Koordinat: " + e.latlng.lat + ", " + e.latlng.lng);
            // Ä°stersen buraya tÄ±klanan yere yeni sensÃ¶r ekleme formu aÃ§tÄ±rabilirsin!
        });

    </script>
</body>
</html>